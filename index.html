<!DOCTYPE html>
<html>
<head>
  <title>Confirm Signature</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: rgba(0,0,0,0.4);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }

    .modal {
      background: white;
      width: 650px;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.3);
      text-align: left;
    }

    h2 {
      margin-top: 0;
      font-size: 20px;
    }

    .terms-text {
      margin-top: 12px;
      font-size: 13px;
      line-height: 1.6;
      color: #333;
    }

    .label-text {
      font-size: 15px;
      margin-bottom: 8px;
      display: block;
      margin-top: 15px;
    }

    .signature-box {
      border: 2px solid #ccc;
      border-radius: 6px;
      width: 100%;
      height: 120px;
      background: #fafafa;
      cursor: text;
      padding: 10px;
      overflow: hidden;
      position: relative;
    }

    #signatureText {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      resize: none;
      font-size: 38px;
      font-family: "Pacifico", cursive;
      color: #555;
      background: transparent;
    }

    #drawCanvas {
      width: 100%;
      height: 120px;
      display: none;
      border: 2px solid #ccc;
      border-radius: 6px;
      background: #fafafa;
    }

    .small-note {
      margin-top: 10px;
      font-size: 13px;
      color: #444;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .checkbox-error {
      margin-top: 6px;
      font-size: 12px;
      color: #d93025;
      display: none;
    }

    .btn-row {
      margin-top: 20px;
      text-align: right;
    }

    button {
      padding: 8px 16px;
      font-size: 15px;
      border-radius: 6px;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .cancel-btn {
      background: #e0e0e0;
      margin-right: 10px;
    }

    .accept-btn {
      background: #64c832;
      color: white;
    }

    .accept-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .switch-mode {
      font-size: 13px;
      margin-top: 6px;
      cursor: pointer;
      color: #0073ff;
      text-decoration: underline;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.5);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .success-box {
      text-align: center;
      padding: 40px 20px;
    }

    .success-box h2 {
      color: #64c832;
      margin-bottom: 10px;
    }

    .success-box p {
      font-size: 15px;
      color: #444;
    }

    @import url('https://fonts.googleapis.com/css2?family=Pacifico&display=swap');
  </style>
</head>

<body>

<div class="modal" id="modal">
  <h2>Confirm Your Acceptance</h2>

  <div id="termsText" class="terms-text"></div>

  <label class="label-text">Please sign your name:</label>

  <div class="signature-box" id="typeModeBox">
    <textarea id="signatureText" placeholder="your name"></textarea>
  </div>

  <canvas id="drawCanvas"></canvas>

  <div class="switch-mode" id="switchMode">Switch to draw signature</div>

  <p class="small-note">
    <input type="checkbox" id="acceptTermsCheckbox" />
    I understand and agree to this being an electronic representation of my signature.
  </p>

  <div class="checkbox-error" id="checkboxError">
    Please confirm by checking this box before continuing.
  </div>

  <div class="btn-row">
    <button class="cancel-btn">Cancel</button>
    <button class="accept-btn" id="acceptBtn">
      <span id="btnText">Complete Signature</span>
    </button>
  </div>
</div>

<script>
  let drawMode = false;

  const switchBtn = document.getElementById("switchMode");
  const textBox = document.getElementById("signatureText");
  const typeBox = document.getElementById("typeModeBox");
  const canvas = document.getElementById("drawCanvas");
  const ctx = canvas.getContext("2d");
  const modal = document.getElementById("modal");
  const termsText = document.getElementById("termsText");
  const acceptBtn = document.getElementById("acceptBtn");
  const btnText = document.getElementById("btnText");
  const checkbox = document.getElementById("acceptTermsCheckbox");
  const checkboxError = document.getElementById("checkboxError");

  function resizeCanvas() {
    canvas.width = typeBox.clientWidth;
    canvas.height = 120;
  }
  resizeCanvas();

  switchBtn.onclick = () => {
    drawMode = !drawMode;
    if (drawMode) {
      typeBox.style.display = "none";
      canvas.style.display = "block";
      switchBtn.textContent = "Switch to typed signature";
    } else {
      canvas.style.display = "none";
      typeBox.style.display = "block";
      switchBtn.textContent = "Switch to draw signature";
    }
  };

  let drawing = false;

  canvas.addEventListener("mousedown", e => {
    drawing = true;
    ctx.beginPath();
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.moveTo(e.offsetX, e.offsetY);
  });

  canvas.addEventListener("mousemove", e => {
    if (!drawing) return;
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  });

  canvas.addEventListener("mouseup", () => drawing = false);
  canvas.addEventListener("mouseout", () => drawing = false);

  function getQueryParam(param) {
    return new URLSearchParams(window.location.search).get(param);
  }

  const clientName = getQueryParam("client");
  const jobUUID = getQueryParam("jobUUID");
  const docId = getQueryParam("docId");

  if (clientName) {
    textBox.value = clientName.trim().split(" ")[0];
  }

  textBox.addEventListener("input", () => {
    const value = textBox.value.trim();
    if (value.includes(" ")) {
      alert("Please enter only your first name.");
      textBox.value = value.split(" ")[0];
    }
  });

  async function loadTerms() {
    try {
      const res = await fetch(
        `https://database-psi-eight.vercel.app/api/get-terms?jobUUID=${jobUUID}`
      );
      const data = await res.json();
      termsText.innerText = data.termsText || "";
    } catch {
      termsText.innerText = "";
    }
  }

  if (!docId) {
    loadTerms();
  } else {
    termsText.style.display = "none";
  }

  function typedSignatureToBase64(text) {
    const scale = 4;
    const padding = 24;
    const height = 120;

    const measureCanvas = document.createElement("canvas");
    const measureCtx = measureCanvas.getContext("2d");
    measureCtx.font = "38px 'Pacifico', cursive";

    const textWidth = measureCtx.measureText(text).width;
    const logicalWidth = Math.ceil(textWidth + padding * 2);

    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = logicalWidth * scale;
    tempCanvas.height = height * scale;

    const tctx = tempCanvas.getContext("2d");
    tctx.scale(scale, scale);
    tctx.imageSmoothingEnabled = true;
    tctx.imageSmoothingQuality = "high";

    tctx.clearRect(0, 0, logicalWidth, height);
    tctx.font = "38px 'Pacifico', cursive";
    tctx.fillStyle = "#000";
    tctx.textAlign = "left";
    tctx.textBaseline = "middle";
    tctx.fillText(text, padding, height / 2);

    return tempCanvas.toDataURL("image/png");
  }

  checkbox.addEventListener("change", () => {
    if (checkbox.checked) {
      checkboxError.style.display = "none";
    }
  });

  document.getElementById("acceptBtn").onclick = async () => {
    if (!checkbox.checked) {
      checkboxError.style.display = "block";
      return;
    }

    if (!drawMode && textBox.value.trim() === "") return;
    if (!jobUUID) return;

    acceptBtn.disabled = true;
    btnText.innerHTML = `<span class="spinner"></span> Processing...`;

    const signatureBase64 = drawMode
      ? canvas.toDataURL("image/png")
      : typedSignatureToBase64(textBox.value.trim());

    try {
      if (docId) {
        await fetch("https://docs-backend-gilt.vercel.app/api/auth-test", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ docId, jobUUID, signatureBase64 })
        });
      } else {
        const termsNote = termsText.innerText.trim();
        await fetch("https://note-fixed-final.vercel.app/api/signature", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ jobUUID, note: termsNote })
        });

        await fetch(
          "https://attachment-backendddd-zie8.vercel.app/api/signature-upload",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ jobUUID, signature: signatureBase64 })
          }
        );
      }

      modal.innerHTML = `
        <div class="success-box">
          <h2>Signature Captured</h2>
          <p>Your signature has been successfully recorded.</p>
        </div>
      `;
    } catch (error) {
      console.error(error);
    }
  };
</script>

</body>
</html>
